# 如果觉得好用，请收藏或则分享本站
Logging:
  LogLevel:
    Default: Debug
    Microsoft.AspNetCore: Warning
AllowedHosts: '*'
WafInfos:
  Listens:
    - Host: 0.0.0.0
      Port: 7031
    - Port: 5002
      Host: 0.0.0.0
      # AutoHttpsPort: 443
    - Host: 0.0.0.0
      Port: 443
      IsHttps: true
  Certs:
    - Host: "*.lx"
      PemFile: .well-known/pri_key.pem
      KeyFile: .well-known/pri_key.pem.key
    - Host: "*."
      PemFile: .well-known/pri_key.pem
      KeyFile: .well-known/pri_key.pem.key
  HeaderUps:
    aa: bb
    cc: dd
  HeaderDowns:
    ee: ff
    gg: hh
  Forwarded:
    IsX: false
    Method: append
Statistic:
  PathStas:
    # 不带任何的就是需要完整匹配如 /api
    # 后面带有星号的就是前缀匹配如 /api/*
    # 中间带有大括号的则表示规则匹配  /api/{aaa}/bbb 则 /api/xxx/bbb 符合, /api/aass/dd/bbb不符合
    # 匹配到任一规则后则不进行后续匹配, 未匹配到则按原请求进行统计
    - /api/{aaa}/bbb
    - /api/cc/dd/*
    - /api1/*
    - /file/*
    - /api1/aaaa
  WhitePaths:
    - /api2/*
    - /file/*
  Config:
    # 最小的检测数量, 访问数大于该数才进行检查是否合法, 请设置大于20的值
    fbLimit: 30
    # 上一条请求还未结束直接发下一条的请求
    notWaitFbRatio: 0.9
    # 默认的封禁时长, 单位为秒
    defaultFbTime: 200
    # 取最高频率的几项进行计算占比
    maxFreqGetNums: 3
    # 至少需要访问的次数
    maxFreqMinReqs: 100
    # 前几的占比超过该比例则封禁
    maxFreqFbRatio: 0.8
  LimitCc:
    - Period: 60
      LimitNum: 20
      Path: /api1/*
      FbTime: "00:03:00"
Protect:

  # 检查query里面的请求
  OpenArgsCheck: true
  # Post检查会预先读取body的内容, 会比较大的程度拖慢响应速度
  OpenPostCheck: true
  # 最大请求大小
  MaxRequestBodySize: 10000
  # 具体的检测参数正则配置
  RegexArgsList:
    - (?:aaa\/\W*passwd)
  # 具体的检测参数正则配置
  RegexPostList:
    - (?:aaa\/\W*passwd)

# =============== 访问控制配置 ===============
# 整合 IP 访问控制、地理位置访问控制和连接限制
# 白名单 IP 直接放行，不进行 GeoIp 检查
# 每个子模块（IpControl、GeoControl、ConnectionLimit）都有独立的 Enabled 开关
AccessControl:
  # 拒绝访问时返回的 HTTP 状态码
  RejectStatusCode: 403
  # 拒绝访问时返回的消息
  # 支持占位符: {ClientIp}, {Path}, {Method}, {Host}, {Time}, {Country}, {Region}, {City}, {Isp}
  RejectMessage: "Access Denied: {ClientIp}"

  # 全局 IP 白名单，支持 CIDR 格式
  # 白名单中的 IP 直接放行，不受任何访问控制限制（包括 IpControl、GeoControl）
  Whitelist:
    # - 127.0.0.1
    # - 10.0.0.0/8           # 10.x.x.x 内网
    # - 172.16.0.0/12        # 172.16.x.x - 172.31.x.x 内网
    # - 192.168.0.0/16       # 192.168.x.x 内网

  # =============== IP 黑名单访问控制配置 ===============
  IpControl:
    # 是否启用 IP 黑名单访问控制
    Enabled: true
    # IP 黑名单，支持 CIDR 格式
    # 黑名单中的 IP 将被拒绝访问
    Blacklist:
      # - 127.0.0.0/8
      # - 1.2.3.4            # 单个 IP
      # - 1.2.3.0/24         # 1.2.3.0 - 1.2.3.255 整个网段
      # - 203.0.113.0/24     # 示例网段
    # 基于路径的 IP 访问规则
    PathRules:
      # /admin/* 路径只允许内网访问
      /admin/*:
        Whitelist:
          - 127.0.0.1
          - 192.168.0.0/16
        Blacklist: []
      # /api/internal/* 路径拒绝外网访问
      # /api/internal/*:
      #   Whitelist:
      #     - 10.0.0.0/8
      #   Blacklist: []

  # =============== 地理位置访问控制配置 ===============
  # 基于 IP2Region 实现高性能 IP 地理位置查询
  # 数据库下载: https://github.com/lionsoul2014/ip2region/tree/master/data
  GeoControl:
    # 是否启用地理位置访问控制
    Enabled: True
    # IP2Region 数据库文件路径（xdb 格式）
    DatabasePath: "datas/ip2region.xdb"
    # 访问控制模式: Allow(只允许列表中的国家) 或 Deny(禁止列表中的国家)
    Mode: Deny
    # 拒绝访问时返回的消息（覆盖全局配置）
    # 支持占位符: {ClientIp}, {Country}, {Region}, {City}, {Isp}
    RejectMessage: "Access denied from your region: {Country}"
    # 允许访问的国家/地区列表（当 Mode 为 Allow 时生效）
    # 支持: 国家名称、省份、城市
    AllowCountries:
      # - 中国
      # - 美国
      # - 日本
    # 禁止访问的国家/地区列表（当 Mode 为 Deny 时生效）
    DenyCountries:
      - 中国
      # - 朝鲜
      # - 伊朗
    # 基于路径的地理位置规则
    PathRules:
      # 示例: /admin/* 只允许中国访问
      # /admin/*:
      #   Whitelist:
      #     - 中国
      #   Blacklist: []
      # 示例: /api/internal/* 禁止海外访问
      # /api/internal/*:
      #   Whitelist:
      #     - 中国
      #   Blacklist: []

  # =============== 连接限制配置 ===============
  ConnectionLimit:
    # 是否启用连接限制
    Enabled: false
    # 每个客户端 IP 的最大并发连接数，0 表示不限制
    MaxConnectionsPerIp: 100
    # 每个后端服务器的最大并发连接数，0 表示不限制
    MaxConnectionsPerDestination: 1000
    # 全局最大并发连接数，0 表示不限制
    MaxTotalConnections: 10000
    # 超过连接限制时返回的 HTTP 状态码
    RejectStatusCode: 503
    # 超过连接限制时返回的消息
    # 支持占位符: {ClientIp}, {Path}, {Method}, {Host}, {Time}
    RejectMessage: "Too Many Connections: {ClientIp}"
    # 基于路径的连接限制
    # Key 为路径（支持通配符），Value 为最大连接数
    PathLimits:
      /api/heavy/*: 10
      /download/*: 50

SpeedLimit:
  Limits:
    # Fixed 固定窗口
    # Sliding 滑动窗口
    # Token 令牌桶
    # Concurrency 并发限定
    # https://learn.microsoft.com/zh-cn/aspnet/core/performance/rate-limit?view=aspnetcore-9.0
    Global:
      Name: Fixed
      PermitLimit: 20
      Window: "00:00:05"
      QueueOrder: 0
      QueueLimit: 10
    Fixed:
      Name: Fixed
      PermitLimit: 20
      Window: "00:00:05"
      QueueOrder: 0
      QueueLimit: 10
    Sliding:
      Name: Sliding
      PermitLimit: 20
      Window: "00:00:05"
      SegmentsPerWindow: 10
      QueueOrder: 0
      QueueLimit: 10
    Token:
      Name: Token
      PermitLimit: 20
      ReplenishmentPeriod: "00:00:05"
      TokensPerPeriod: 10
      QueueOrder: 0
      QueueLimit: 10
    Concurrency:
      Name: Concurrency
      PermitLimit: 1
      QueueOrder: 0
      QueueLimit: 0
  Default: Global
  Throttled:
    # 全局限速, 以下速度均为 K/s
    Global: 0
    Everys:
      /api/*: 100
      /file/*: 10
    IpEverys:
      127.0.0.1: 300

FileProvider:
  Everys:
    127.0.0.1#/file:
      BasePath: E:/caishen
      MaxFileSize: 1024 #单位K
      TryFiles:
        - $path
        - $path/
        - caishen13.cn/$path
  RemoveExtensions:
    -
      ".css1"
  MimeExtensions:
    ".png": "application/octet-stream"
ReverseProxy:
  Routes:
    route1:
      ClusterId: cluster1
      Match:
        Path: 'test1/{**catch-all}'
      Transforms:
        # Forwarded:proto=http;host="127.0.0.1:5002";for=192.168.1.117;by=_1ecb8ezFf
        # -
        #   Forwarded: by,for,host,proto
        #   ForFormat: ip
        #   ByFormat: Random
        #   Action: Append
        # 自动添加格式
        # -
        #   X-Forwarded: Set
        #   For: Append
        #   HeaderPrefix: X-Forwarded-
        # -
        #   RequestHeader: X-Forwarded-For
        #   Append: '{RemoteIpAddress}'
    route2:
      ClusterId: cluster2
      Match:
        Path: '{**catch-all}'
    route3:
      ClusterId: cluster2
      Match:
        Path: 'file/{**file-all}'
      Metadata:
        RateLimiter: Concurrency
  Clusters:
    cluster1:
      # =============== HTTP客户端/连接池配置 ===============
      # YARP 使用 HttpClient 连接池管理后端连接
      HttpClient:
        # 每个后端服务器的最大连接数（默认200）
        # 建议根据后端服务器吞吐能力设置在100-500之间
        MaxConnectionsPerServer: 200
        # 请求超时时间（默认100秒，建议30秒）
        # RequestTimeout: '00:00:30'
        # SSL协议版本
        # SslProtocols: 'Tls12, Tls13'
        # 是否允许不受信任的SSL证书（生产环境应为false）
        # DangerousAcceptAnyServerCertificate: false
      
      # =============== 负载均衡策略配置 ===============
      # 支持的负载均衡策略:
      #   RoundRobin        - 轮询 (默认): 按顺序分发请求
      #   Random            - 随机: 随机选择服务器
      #   LeastRequests     - 最少连接: 将请求发给当前连接数最少的服务器
      #   PowerOfTwoChoices - 二选一: 随机选两个，取负载低的那个
      #   First             - 总是第一个: 始终选择第一个可用的目标
      #   ---------- 自定义策略 ----------
      #   WeightedRoundRobin     - 加权轮询: 根据服务器权重分配请求
      #   WeightedLeastConnections - 加权最少连接: 考虑权重的连接数最少算法
      #   IpHash                 - IP哈希: 基于客户端IP分配，确保同一用户访问同一服务器
      #   GenericHash            - 通用哈希: 基于自定义变量（如URL、参数）进行哈希
      #   WeightedRandom         - 加权随机: 根据权重随机选择服务器
      #   ConsistentHash         - 一致性哈希: 使用一致性哈希环，节点变化时最小化请求迁移
      LoadBalancingPolicy: WeightedRoundRobin
      HealthCheck:
        Active:
          Enabled: true
          Interval: '00:00:10'
          Timeout: '00:00:10'
          Policy: LyxActiveHealth
          Path: /api/health
          Query: aa=bb
      Metadata:
        # 连续失败两次则标记不健康, 超过次数则清除成功标记, 并标为不健康
        LyxActiveHealth.Fails: 2
        # 连续成功两次则标记健康, 超过次数则清除失败标记, 并标为不健康
        LyxActiveHealth.Passes: 2
        # 请求方法, 默认GET, 如果为POST将会取LyxActiveHealth.Body做为请求内容
        LyxActiveHealth.Method: GET
        # 如果可转化成JSON则自动用JSON格式请求
        # 如果不行则用application/x-www-form-urlencoded请求
        LyxActiveHealth.Body: '{"aa": "bb"}'
        # 用逗号隔开2xx则表示2开头的都行, 可以指定编码
        LyxActiveHealth.AvalidCode: 2xx,3xx,4xx
        # 默认包含:Contains, 全部匹配Match, 
        # JSON验证则为JSON,将会将内容转成JSON进行匹配, 表示包含
        # JSONM则表示完全匹配
        LyxActiveHealth.ContentCheck: "Match"
        LyxActiveHealth.AvalidContent: "WebSocket"
        LyxActiveHealth.AvalidHeaders: Transfer-Encoding=chunked
        # =============== GenericHash/ConsistentHash 哈希键配置 ===============
        # 支持的变量:
        #   {Path}        - 请求路径
        #   {Query}       - 完整查询字符串
        #   {Query.xxx}   - 指定查询参数
        #   {Header.xxx}  - 指定请求头
        #   {Cookie.xxx}  - 指定Cookie
        #   {IP}          - 客户端IP
        # 示例: HashKey: "{IP}"                    # 按IP分配 (默认)
        # 示例: HashKey: "{Path}"                  # 按路径分配
        # 示例: HashKey: "{Query.user_id}"         # 按用户ID参数分配
        # 示例: HashKey: "{Header.Authorization}"  # 按认证头分配
        # 示例: HashKey: "{Cookie.session_id}"     # 按会话ID分配
        # HashKey: "{IP}"

      Destinations:
        destination1:
          # Address: 'http://127.0.0.1:8080/'
          Address: 'https://ttw.caishen.ai/'
          Metadata:
            # 权重配置: 用于 WeightedRoundRobin, WeightedLeastConnections, WeightedRandom
            # 权重越高，被分配的请求越多
            Weight: "3"
            # 虚拟节点数: 用于 ConsistentHash, 默认150
            # VirtualNodes: "150"
        destination2:
          Address: 'https://ttw.caishen.ai/'
          Metadata:
            Weight: "1"
    cluster2:
      # 使用 IP 哈希策略
      LoadBalancingPolicy: IpHash
      Destinations:
        destination1:
          # Address: 'http://127.0.0.1:8080/'
          Address: 'https://ttw.caishen.ai/'
