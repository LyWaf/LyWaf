# ============================================================
# LyWaf 配置文件示例 (config.ly)
# 类似 Caddy 的简洁配置格式
# 格式参考: https://caddyserver.com/docs/caddyfile/concepts
# ============================================================

# 变量定义
var domain = "example.com"
var backend = "127.0.0.1:8080"
var env = "production"

# ============================================================
# 全局选项（可选，必须在最前面）
# ============================================================
{
    # ACME 邮箱（用于 Let's Encrypt）
    email admin@example.com
    
    # 使用 staging 环境测试
    if $env != "production" {
        acme_staging true
    }
    
    # 调试模式
    # debug
}

# ============================================================
# 代码片段（可重用配置）
# ============================================================
(common_headers) {
    HeaderUps {
        X-Real-IP = "{ClientIp}"
        X-Forwarded-For = "{ClientIp}"
    }
}

(rate_limit) {
    SpeedLimit {
        Limits {
            Fixed {
                PermitLimit = 100
                Window = "00:01:00"
            }
        }
    }
}

# ============================================================
# 站点配置（以域名或地址开头）
# ============================================================

# 证书配置（根目录下）
Certs {
    # 默认证书
    PemFile = "/path/to/default-cert.pem"
    KeyFile = "/path/to/default-key.pem"
    
    # 域名特定证书
    $domain {
        PemFile = "/path/to/${domain}-cert.pem"
        KeyFile = "/path/to/${domain}-key.pem"
    }
    
    api.${domain} {
        PemFile = "/path/to/api-cert.pem"
        KeyFile = "/path/to/api-key.pem"
    }
}

# 主站点 - 支持多路由配置
$domain www.${domain} {
    # 不同路径转发到不同后端
    /api/* {
        reverse_proxy http://127.0.0.1:3000
        lb_policy RoundRobin
    }
    
    /file/* {
        reverse_proxy http://127.0.0.1:4000
    }
    
    # 静态文件服务
    /static/* {
        file_server {
            root = "./wwwroot/static"
            browse = true
            index = "index.html index.htm"
        }
    }
    
    # 默认路由（其他所有请求）
    reverse_proxy http://${backend}
}

# 纯文件服务站点
files.${domain} {
    # 简单的文件服务（使用当前目录）
    file_server
}

# 带配置的文件服务
static.${domain} {
    file_server {
        root = "./public"
        browse = true
        index = "index.html default.html"
        try_files = "index.html /404.html"
        precompressed = true
    }
}

# API 站点 - 使用 handle 块
api.${domain} {
    handle {
        /v1/* {
            reverse_proxy http://127.0.0.1:3001
        }
        /v2/* {
            reverse_proxy http://127.0.0.1:3002
        }
    }
    
    # 默认后端
    reverse_proxy http://127.0.0.1:3000
    lb_policy WeightedRoundRobin
}

# 管理后台 - HTTPS
https://admin.${domain} {
    reverse_proxy http://127.0.0.1:9000
}

# 端口监听（无域名限制）
:8080 {
    reverse_proxy http://127.0.0.1:8081
}

# HTTPS 端口监听
https://:443 {
    # 这将监听所有域名的 443 端口
    reverse_proxy http://127.0.0.1:8080
}

# 本地开发
localhost:3000 {
    reverse_proxy http://127.0.0.1:3000
}

# ============================================================
# 其他全局配置
# ============================================================

# 访问控制
AccessControl {
    RejectStatusCode = 403
    RejectMessage = "Access Denied: {ClientIp}"
    
    Whitelist = ["127.0.0.1", "10.0.0.0/8"]
    
    IpControl {
        Enabled = true
        Blacklist = ["1.2.3.4"]
    }
}

# 响应压缩
Compress {
    Enabled = true
    EnableBrotli = true
    EnableGzip = true
    Level = "Fastest"
    MinSize = 10240
}

# ACME 配置（Let's Encrypt）
Acme {
    Enabled = true
    AcceptTermsOfService = true
    Domains = [$domain, "www.${domain}", "api.${domain}"]
    
    if $env == "production" {
        UseStaging = false
    } else {
        UseStaging = true
    }
}

# ============================================================
# 条件配置
# ============================================================
if $env == "development" {
    Logging {
        Level = "Debug"
    }
}

if $env == "production" {
    Logging {
        Level = "Info"
    }
}

# 导入其他配置文件
# import "sites/*.ly"
